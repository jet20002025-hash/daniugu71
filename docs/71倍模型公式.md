# 71 倍模型公式回顾（mode3 原版）

**当前主模型为 mode9**（在 mode3 基础上增加均线整齐度、粘连、拐回、量比按比例扣分等），见 [mode9模型说明.md](mode9模型说明.md)。  
本文档保留 **71 倍 / mode3 原版** 公式说明，供对比与回测使用。

代码位置：`app/scanner.py`（`_mode3_signals`、`_score_mode3`），回测见 `scripts/backtest_mode3_2023_2024.py` 等。

---

## 一、数据与起算

- **均线与量能**：收盘价、成交量的简单移动平均，窗口 10/20/60（日）、量能 20 日均量。
- **起算 K 线**：从第 **60 根 K 线**开始才可能出信号（即需要至少 60 个交易日历史）。
- **买入日**：信号日 T，买入日为 **T+1 开盘**（次日开盘买）。

---

## 二、信号条件（是否进入候选）

某日 `i`（`i ≥ 60`）要成为 **mode3 信号日**，需**同时**满足：

| 条件 | 公式/说明 |
|------|-----------|
| 均线多头 | **MA10(i) > MA20(i) > MA60(i)** |
| 均线向上 | MA10、MA20、MA60 相对 3 日前均线斜率 > 0（即 `ma[i] - ma[i-3] > 0`） |
| 收盘在 MA20 上 | **close(i) ≥ MA20(i)** |
| 放量 | **volume(i) ≥ vol20(i) × 1.2**（当日量 ≥ 20 日均量 1.2 倍） |
| 20 日涨幅不过高 | 若 `close(i-20)>0`，则 `(close(i)-close(i-20))/close(i-20)×100 ≤ 25`（20 日涨幅 ≤ 25%） |

以上全部为**当日及历史**数据，无未来数据。

---

## 三、评分公式（0–100+，用于排序与过滤）

基础分 **60**，再按下列规则加减（仅用当日及历史）：

| 项目 | 规则 | 分值 |
|------|------|------|
| MA10 与 MA20 间距 | gap = (MA10 - MA20) / MA20；≥2% 加 10，≥1% 加 6，≥0.5% 加 3 | +3～+10 |
| MA20 与 MA60 间距 | gap = (MA20 - MA60) / MA60；≥2% 加 10，≥1% 加 6，≥0.5% 加 3 | +3～+10 |
| 量比 | vol_ratio = volume / vol20；≥1.6 加 15，≥1.4 加 10，≥1.2 加 6 | +6～+15 |
| 收盘相对 MA20 | close_gap = (close - MA20) / MA20；≥3% 加 5，≥1% 加 3 | +3～+5 |
| 近 3 日涨幅 | ret3 > 20% 扣 10 分，> 15% 扣 5 分 | -5～-10 |
| MA5 拐头 | 若今日 MA5 < 昨日 MA5，扣 5 分 | -5 |

最终：`score = int(max(0, round(分数)))`。  
筛选时通常只保留 **score ≥ min_score**（如 70）。

---

## 四、每日排序（取 top1 / topN）

在**不启用上影线偏好**时，同一天内候选按以下键排序（先按分数，再按其它，**仅用当日/历史**）：

1. **-score**（分数高优先）
2. **close_gap**（收盘距 MA20 的 gap，小优先、避免追高）
3. **-vol_ratio**（量比大优先）
4. **-(ma20_gap + ma60_gap)**（均线间距大优先）
5. **ret20_val**（20 日涨幅）
6. **code**（代码稳定排序）

每日取前 **max_results** 条（如 top1 即取 1 条），作为该日选股，**禁止用未来数据（如未来 N 日最高价）排序**。

---

## 五、回测规则（与 71 倍一致）

- **买入**：信号日 T，**T+1 开盘价**买入。
- **卖出**：满足其一即卖  
  - **破 10 日均线**（收盘 < MA10）；或  
  - **10% 止损**（当日最低价 ≤ 买入价×0.9）；或  
  - 回测截止日平仓。
- **仓位**：单只满仓、T+1（卖出当日不买）、按最小交易单位（主板 100、创业板/科创板 200 等）。

---

## 六、可选过滤（71 倍标准）

- **use_71x_standard=True**：不做「近一年最高/最低价比 ≥ 4 倍」过滤。
- **use_71x_standard=False**：可启用一年高低价比等过滤（见 `config.year_high_low_ratio_limit`）。

---

## 七、小结

- **信号**：60 根 K 线起算，MA10>MA20>MA60 且三线向上、收盘≥MA20、放量≥1.2 倍、20 日涨幅≤25%。
- **评分**：基础 60 分，按均线间距、量比、收盘距 MA20、近 3 日涨幅、MA5 拐头加减分。
- **排序与选股**：仅用 **score** 及当日/历史指标排序，每日取 top1/topN，**禁止使用未来数据**。
- **回测**：T+1 开盘买，破 MA10 或 10% 止损或期末平仓。

以上全部为**当日及历史**数据，无 look-ahead。
