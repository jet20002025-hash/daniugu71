# mode9「最近 6 个交易日有涨停」权重公式

## 一、涨停判定（按板块）

| 板块 | rate | 涨停条件（日涨幅 ≥） |
|------|------|------------------------|
| ST | 5% | pct_chg ≥ 4.5 |
| 创业板/科创板(30/301/688) | 20% | pct_chg ≥ 19.5 |
| 北交所(8/9 开头) | 30% | pct_chg ≥ 29.5 |
| 主板等 | 10% | pct_chg ≥ 9.5 |

公式：**涨停日** 满足 `pct_chg[i] ≥ (rate×100) - 0.5`，其中 `rate = _limit_rate(code, name)`。

---

## 二、当前实现：涨停且次日缩量（权重体现）

**条件**：买点日（信号日）前 **6 个交易日**内，存在某日 `i` 满足：

1. **当日涨停**：`pct_chg[i] ≥ limit_up`（limit_up 见上表）
2. **次日缩量**：`volume[i+1] < volume[i] × 1.8`

**权重体现**：

| 方式 | 公式/规则 |
|------|-----------|
| **加分** | 满足则 `base += 2`（在 mode9 总分上直接 +2） |
| **同分排序** | 排序键中增加 `limitup_shrink_vol`：满足=1、不满足=0，**降序**，即同分时「有涨停+缩量」的排在前面。 |

即：**总分权重 = +2 分；排序权重 = 同分时 有=1 优先于 无=0**。

---

## 三、若只考虑「最近 6 日有涨停」（不要求缩量）的权重公式

若希望**只要 6 日内出现过涨停**就体现权重（不要求次日缩量），可以按下面两种方式之一实现。

### 方案 A：只加分（推荐）

- 定义 0/1 特征：
  - `has_limit_up_6d = 1` 当且仅当存在 `i ∈ [idx-6, idx-1]` 且 `pct_chg[i] ≥ limit_up`  
  - 否则 `has_limit_up_6d = 0`
- **权重公式**：
  - `加分数 = has_limit_up_6d × Δ`  
  - 建议 `Δ = 1` 或 `2`（与现有「涨停+缩量」的 +2 对齐或略低）。
- 代码：在 `_score_mode9` 中若 `_has_limit_up_in_lookback(rows, idx, code, name, lookback=6)` 为 True，则 `base += Δ`。

### 方案 B：只参与排序（不加分）

- 同分时增加排序键：`-has_limit_up_6d`（有涨停=1 排前）。
- 不改变总分，只影响「分数相同谁排前面」。

### 方案 C：加分 + 排序都体现

- **加分**：`base += has_limit_up_6d × Δ`（如 Δ=1）。
- **排序**：在 `_mode3_sort_key` 中增加 `-has_limit_up_6d`（有涨停的排前）。

---

## 四、统一公式（可写进代码/文档）

设信号日下标为 `idx`，买点前 6 个交易日为 `i ∈ [idx-6, idx-1]`（若 `idx-6<0` 则从 0 起）。

1. **涨停日判定**  
   `is_limit_up(i) = (pct_chg[i] ≥ (rate×100) - 0.5)`，其中 `rate` 由 `_limit_rate(code, name)` 得到。

2. **最近 6 日有涨停（0/1）**  
   `has_limit_up_6d = max{ is_limit_up(i) : i ∈ [max(0, idx-6), idx-1] }`  
   （有任意一天涨停则为 1，否则为 0。）

3. **当前「涨停+缩量」条件（已有）**  
   `limitup_shrink_vol = 1` 当且仅当存在上述某日 `i` 涨停 **且** `volume[i+1] < volume[i] × 1.8`；否则 0。

4. **权重体现（当前实现）**  
   - 总分：`score += 2 * limitup_shrink_vol`  
   - 排序：同分时按 `(-score, -limitup_shrink_vol, -buy_point_score, …)`，即 `limitup_shrink_vol` 大的排前。

5. **若增加「仅 6 日涨停」权重（建议公式）**  
   - 加分：`score += Δ * has_limit_up_6d`，例如 `Δ = 1`。  
   - 排序：在 sort_key 中增加一项 `-has_limit_up_6d`（有涨停的排前）。

如需在代码里加上「仅 6 日有涨停」的加分或排序，可说明选方案 A/B/C 及 Δ 取值，再改 `_score_mode9` 与 `_mode3_sort_key`。
