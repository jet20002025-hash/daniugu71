<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>强势股右侧筛选器</title>
  <link rel="stylesheet" href="/static/styles.css" />
</head>
<body>
  <div class="bg" aria-hidden="true"></div>
  <main class="container">
    <header class="hero">
      <div>
        <p class="eyebrow">超短线 · 右侧强势</p>
        <h1>强势股筛选器</h1>
        <p class="subtitle">按既定规则自动筛选符合强势特征的候选列表（不提供买点/荐股）。<a href="/score" style="margin-left:0.5em;">个股评分</a></p>
        {% if user %}
        <p class="user-bar" style="margin-top:10px;font-size:14px;color:var(--muted)">
          {{ user.username }}
          {% if user.is_activated %} · <span style="color:var(--accent-2)">已开通</span>{% elif not user.trial_ended %} · 试用中（{{ user.trial_ends_at[:10] }} 前）{% endif %}
          <a href="{{ url_for('logout') }}" style="margin-left:12px;color:var(--accent-2)">退出</a>
          {% if user.is_admin %} · <a href="{{ url_for('admin') }}" style="color:var(--accent)">管理后台</a>{% endif %}
        </p>
        {% endif %}
      </div>
      <div class="status-card">
        <div class="status-row">
          <span>状态</span>
          <strong id="status-text">{{ '运行中' if state.running else '空闲' }}</strong>
        </div>
        <div class="status-row">
          <span>进度</span>
          <strong id="status-progress">{{ state.progress|default(0) }}/{{ state.total|default(0) }}</strong>
        </div>
        <div class="status-row">
          <span>消息</span>
          <strong id="status-message">{{ state.message }}</strong>
        </div>
        <div class="status-row">
          <span>来源</span>
          <strong id="status-source">{{ '本地' if state.source == 'gpt' else (state.source or '未知') }}</strong>
        </div>
        <div class="status-row">
          <span>错误</span>
          <strong id="status-error">{{ state.error or '无' }}</strong>
        </div>
        <div class="status-row">
          <span>模型</span>
          <strong id="status-model">mode9</strong>
        </div>
        <div class="status-row">
          <span>上次更新</span>
          <strong id="status-last">{{ meta.updated_at or '暂无' }}</strong>
        </div>
        <div class="status-row">
          <span>K线缓存</span>
          <strong id="status-cache">—</strong>
        </div>
      </div>
    </header>

    <section class="panel">
      <form class="form" method="post" action="/scan" id="scan-form">
        <label>
          开始日期
          <input type="date" name="start_date" id="start_date" />
        </label>
        <label>
          截止日期
          <input type="date" name="cutoff_date" id="cutoff_date" />
        </label>
        <label>
          数据源
          <select name="data_source" id="data_source">
            <option value="gpt" selected>本地股票库（推荐，用服务器缓存）</option>
            <option value="remote">在线更新（会请求东财/腾讯，海外服务器易卡）</option>
          </select>
          <span id="data_source_hint" class="hint-inline">使用服务器缓存，不请求外网</span>
        </label>
        <label>
          来源
          <select name="remote_provider" id="remote_provider" title="腾讯日K接口目前只到约 2026-02-13，欲获取今日数据请选东财。">
            <option value="eastmoney" selected>东财</option>
            <option value="tencent">腾讯</option>
            <option value="sina">新浪</option>
            <option value="netease">网易（待接入）</option>
          </select>
        </label>
        <label>
          优先本地
          <div class="toggle-row">
            <input type="checkbox" name="prefer_local" id="prefer_local" />
            <span>已有缓存则不联网</span>
          </div>
        </label>
          <label>
          模型
          <select name="mode" id="mode">
            <option value="mode9" selected>mode9（当前主模型，原71倍升级）</option>
            <option value="mode3">71倍原版(mode3)</option>
            <option value="mode8">mode8（60根K线起算）</option>
          </select>
        </label>
        <label>
          最低分数
          <input type="number" name="min_score" id="min_score" value="70" min="0" max="200" />
        </label>
        <label>
          市值上限(亿)
          <input type="number" name="max_market_cap" id="max_market_cap" value="150" min="0" step="1" />
        </label>
        <label>
          输出数量
          <input type="number" name="max_results" id="max_results" value="200" min="10" max="2000" />
        </label>
        <label>
          并发线程
          <input type="number" name="workers" id="workers" value="6" min="1" max="12" />
        </label>
        <button type="submit" class="primary">开始筛选</button>
      </form>
      <div class="cap-hint">当前市值上限: <strong id="cap-display">150</strong> 亿（填 0 代表不启用）</div>
      <p class="hint">首次运行可能需要较长时间，结果会保存在本地。开始/截止日期可限定区间筛选。</p>
    </section>

    <section class="panel table-panel">
      <div class="table-header">
        <h2>候选列表（{{ meta.count }}）</h2>
        <span>按信号打分降序</span>
        <span class="hint-inline">（T+1 信号日不可交易，当天涨跌幅仅供参考）</span>
      </div>
      {% if meta.score_buckets %}
      <div class="bucket-row">
        <span>分数统计</span>
        <strong>≥120: {{ meta.score_buckets.ge_120 }}</strong>
        <strong>≥140: {{ meta.score_buckets.ge_140 }}</strong>
        <strong>≥160: {{ meta.score_buckets.ge_160 }}</strong>
        <strong>≥180: {{ meta.score_buckets.ge_180 }}</strong>
      </div>
      {% endif %}
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>代码</th>
              <th>名称</th>
              <th>得分</th>
              <th title="衡量当日作为买入点的质量，0～100">买点分值</th>
              <th>当天收盘价</th>
              <th title="信号日涨跌幅，T+1 不可当日交易仅供参考">涨跌幅%</th>
              <th title="本次筛选区间内，该股票最早出现的信号日期">最早出现日期</th>
              <th title="信号日前最近6个交易日内是否出现过涨停（仅看有/无）">最近6日有涨停</th>
            </tr>
          </thead>
          <tbody>
            {% for row in results %}
            <tr>
              <td>{{ row.code }}</td>
              <td>{{ row.name }}</td>
              <td class="score">{{ row.score }}</td>
              <td class="score">{{ row.get("buy_point_score", "—") }}</td>
              <td>{{ "%.2f" % row.latest_close }}</td>
              <td class="pct">{{ "%.2f" % row.change_pct }}</td>
              <td>{{ row.get("first_signal_date", row.get("signal_date", "—")) }}</td>
              <td>
                {% if row.get("has_limit_up_6d") %}
                  是
                {% else %}
                  否
                {% endif %}
              </td>
            </tr>
            {% else %}
            <tr>
              <td colspan="8" class="empty">暂无结果，点击上方按钮开始筛选。</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    const STORAGE_KEY = 'stock_scanner_filters_v1';
    let lastRunning = {{ 'true' if state.running else 'false' }};

    function loadFilters() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        const data = JSON.parse(raw);
        if (data.cutoff_date !== undefined) document.getElementById('cutoff_date').value = data.cutoff_date;
        if (data.start_date !== undefined) document.getElementById('start_date').value = data.start_date;
        if (data.data_source) {
          const source = data.data_source === 'cache' ? 'gpt' : data.data_source;
          document.getElementById('data_source').value = source;
        }
        if (data.remote_provider) document.getElementById('remote_provider').value = data.remote_provider;
        if (data.prefer_local !== undefined) document.getElementById('prefer_local').checked = data.prefer_local;
        if (data.mode) document.getElementById('mode').value = data.mode;
        if (data.min_score) document.getElementById('min_score').value = data.min_score;
        if (data.max_market_cap !== undefined) document.getElementById('max_market_cap').value = data.max_market_cap;
        if (data.max_results) document.getElementById('max_results').value = data.max_results;
        if (data.workers) document.getElementById('workers').value = data.workers;
      } catch (err) {
        // ignore
      }
    }

    function saveFilters() {
      const payload = {
        cutoff_date: document.getElementById('cutoff_date').value,
        start_date: document.getElementById('start_date').value,
        data_source: document.getElementById('data_source').value,
        remote_provider: document.getElementById('remote_provider').value,
        prefer_local: document.getElementById('prefer_local').checked,
        mode: document.getElementById('mode').value,
        min_score: document.getElementById('min_score').value,
        max_market_cap: document.getElementById('max_market_cap').value,
        max_results: document.getElementById('max_results').value,
        workers: document.getElementById('workers').value,
      };
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
      } catch (err) {
        // ignore
      }
    }

    document.getElementById('scan-form').addEventListener('submit', saveFilters);
    const capInput = document.getElementById('max_market_cap');
    const capDisplay = document.getElementById('cap-display');
    const updateCap = () => {
      const raw = capInput.value || '0';
      capDisplay.textContent = raw;
    };
    capInput.addEventListener('input', updateCap);
    updateCap();
    function updateDataSourceHint() {
      const source = document.getElementById('data_source').value;
      const hint = document.getElementById('data_source_hint');
      if (source === 'gpt') {
        hint.textContent = '使用服务器缓存，不请求外网';
        hint.style.color = '';
      } else {
        hint.textContent = '将请求外网，服务器在海外可能很慢或卡在 0，建议改用本地股票库';
        hint.style.color = 'var(--warn, #e67e22)';
      }
    }
    document.getElementById('data_source').addEventListener('change', () => {
      const source = document.getElementById('data_source').value;
      const enableProvider = source !== 'cache';
      document.getElementById('remote_provider').disabled = !enableProvider;
      document.getElementById('prefer_local').disabled = source !== 'remote';
      updateDataSourceHint();
    });
    loadFilters();
    document.getElementById('data_source').dispatchEvent(new Event('change'));
    updateDataSourceHint();

    async function pollStatus() {
      try {
        const res = await fetch('/status');
        const data = await res.json();
        document.getElementById('status-text').textContent = data.running ? '运行中' : '空闲';
        document.getElementById('status-progress').textContent = (data.progress ?? 0) + '/' + (data.total ?? 0);
        document.getElementById('status-message').textContent = data.message || '';
        document.getElementById('status-source').textContent = data.source || '未知';
        document.getElementById('status-error').textContent = data.error || '无';
        document.getElementById('status-last').textContent = data.last_run || '{{ meta.updated_at or "暂无" }}';
        if (lastRunning && !data.running) {
          window.location.reload();
          return;
        }
        lastRunning = data.running;
      } catch (err) {
        // ignore
      }
    }
    setInterval(pollStatus, 2000);

    async function loadCacheStatus() {
      try {
        const res = await fetch('/api/cache_status');
        const d = await res.json();
        const el = document.getElementById('status-cache');
        if (d.file_count === 0) el.textContent = '暂无';
        else el.textContent = '共' + d.file_count + '只' + (d.newest_mtime ? '，最后更新 ' + d.newest_mtime : '') + (d.newest_date_in_data ? '，数据至' + d.newest_date_in_data : '');
      } catch (e) { document.getElementById('status-cache').textContent = '—'; }
    }
    loadCacheStatus();
  </script>
</body>
</html>
